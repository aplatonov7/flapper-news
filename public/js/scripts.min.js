var app=angular.module("flapperNews",["ui.router"]);app.config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("home",{url:"/home",templateUrl:"/home.html",controller:"PostsListCtrl",resolve:{postPromise:["posts",function(t){return t.getAll()}]}}).state("posts",{url:"/posts/{id}",templateUrl:"/posts.html",controller:"PostsCtrl",resolve:{post:["$stateParams","posts",function(t,e){return e.getPostById(t.id)}]}}),e.otherwise("home")}]),PostsListCtrl=function(t,e,n,o){t.userPost={},t.posts=e,t.auth=n,t.login=o,t.currentUser=n.currentUser(),t.pageSize=3,t.currentPage=0,t.$watch(function(){return Math.ceil(t.posts.container.length/t.pageSize)},function(){t.totalPages=Math.ceil(t.posts.container.length/t.pageSize)}),t.prevPage=function(){t.currentPage--},t.nextPage=function(){t.currentPage++},t.paginationStatusNext=function(){return t.currentPage>Math.ceil(t.posts.container.length/t.pageSize)-2},angular.element(document).ready(function(){componentHandler.upgradeAllRegistered()}),t.submitForm=function(){if(t.userPost.title){var n={title:t.userPost.title,content:t.userPost.content,image:t.userPost.image,rating:0};e.addPost(n),t.userPost={}}}},PostsCtrl=function(t,e,n,o,r){angular.element(document).ready(function(){componentHandler.upgradeAllRegistered()}),t.post=n,t.posts=e,t.auth=o,t.login=r,t.submitForm=function(){e.addComment(t.post,t.userComment)}},NavCtrl=function(t,e,n){t.login=n,t.auth=e},AuthCtrl=function(t,e,n,o){t.user={},t.register=function(){n.register(t.user).error(function(e){t.error=e}).then(function(){o.close(),t.user={}})},t.logIn=function(){n.logIn(t.user).error(function(e){t.error=e}).then(function(){o.close(),t.user={}})},t.login=o},PostsListCtrl.$inject=["$scope","posts","auth","login"],PostsCtrl.$inject=["$scope","posts","post","auth","login"],NavCtrl.$inject=["$scope","auth","login"],AuthCtrl.$inject=["$scope","$state","auth","login"],app.controller("PostsListCtrl",PostsListCtrl),app.controller("PostsCtrl",PostsCtrl),app.controller("NavCtrl",NavCtrl),app.controller("AuthCtrl",AuthCtrl),app.filter("startFrom",function(){return function(t,e){return t?(e=+e,t.slice(e)):[]}}),app.factory("posts",["imgurLinkGenerator","$http","auth",function(t,e,n){function o(t,e,n){this.author=t?t:"John Doe",this.body=e?e:"No comment",this.rating=n?n:0}function r(t,e,n,o,r){this.title=t?t:"",this.link=e?e:"",this.content=n?n:"",this.comments=o?o:[],this.rating=r?r:0}var s={container:[]};return s.Post=r,s.Comment=o,s.getAll=function(){return e.get("/posts").success(function(t){angular.copy(t,s.container)})},s.getPostById=function(t){return e.get("/posts/"+t).then(function(t){return t.data})},s.addPost=function(o){o.author=n.currentUser(),(o.image+"").match(/^(http:\/\/){0,1}i.imgur.com\/[A-Za-z0-9]{5,7}\.(jpg|png|jpeg|gif)$/i)?e.post("/posts",o,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(t){s.container.push(t)}):t.getImgurLink().then(function(t){o.image=t,e.post("/posts",o,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(t){s.container.push(t)})})},s.addComment=function(t,o){return o.author=n.currentUser(),e.post("/posts/"+t._id+"/comments",o,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){t.comments.push(e)})},s.upvotePost=function(t){return e.put("/posts/"+t._id+"/upvote",null,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){t.rating+=1})},s.downvotePost=function(t){return e.put("/posts/"+t._id+"/downvote",null,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(e){t.rating-=1})},s.upvoteComment=function(t,o){return e.put("/posts/"+t._id+"/comments/"+o._id+"/upvote",null,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(t){o.rating+=1})},s.downvoteComment=function(t,o){return e.put("/posts/"+t._id+"/comments/"+o._id+"/downvote",null,{headers:{Authorization:"Bearer "+n.getToken()}}).success(function(t){o.rating-=1})},s}]),app.factory("auth",["$http","$window",function(t,e){var n={};return n.saveToken=function(t){e.localStorage["flapper-news-token"]=t},n.getToken=function(){return e.localStorage["flapper-news-token"]},n.isLoggedIn=function(){var t=n.getToken();if(t){var o=JSON.parse(e.atob(t.split(".")[1]));return o.exp>Date.now()/1e3}return!1},n.currentUser=function(){if(n.isLoggedIn()){var t=n.getToken(),o=JSON.parse(e.atob(t.split(".")[1]));return o.username}},n.register=function(e){return t.post("/register",e).success(function(t){n.saveToken(t.token)})},n.logIn=function(e){return t.post("/login",e).success(function(t){n.saveToken(t.token)})},n.logOut=function(){e.localStorage.removeItem("flapper-news-token")},n}]),app.factory("login",["$rootScope","auth",function(t,e){var n={};return n.open=function(){e.isLoggedIn()||(n.mode=!0,n.modal=!0)},n.close=function(){n.modal=!1},n}]),app.factory("imgurLinkGenerator",["$q",function(t){function e(t,e){return Math.round(Math.random()*(e-t)+t)}function n(t){for(var i,u=e(0,1)?5:7,a="";u--;)i=r[e(0,s)],a+=i;img=new Image,img.addEventListener("load",function(){this.width<=300||this.height<=300?n(t):t.resolve(this.src)},!1),img.addEventListener("error",function(){n(t)},!1),img.src=o+a+".jpg"}var o="http://i.imgur.com/",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=r.length-1,i=function(){var e=t.defer();return n(e),e.promise};return{getImgurLink:i}}]);