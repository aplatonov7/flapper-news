var app=angular.module("flapperNews",["ui.router"]);app.config(["$stateProvider","$urlRouterProvider",function(t,n){t.state("home",{url:"/home",templateUrl:"/home.html",controller:"MainCtrl",resolve:{postPromise:["posts",function(t){return t.getAll()}]}}).state("posts",{url:"/posts/{id}",templateUrl:"/posts.html",controller:"PostsCtrl",resolve:{post:["$stateParams","posts",function(t,n){return n.getPostById(t.id)}]}}),n.otherwise("home")}]),app.controller("MainCtrl",["$scope","posts",function(t,n){t.userPost={},t.posts=n,t.mode=!0,t.modal=!1,t.pageSize=3,t.currentPage=0,t.$watch(function(){return Math.ceil(t.posts.container.length/t.pageSize)},function(){t.totalPages=Math.ceil(t.posts.container.length/t.pageSize)}),t.prevPage=function(){t.currentPage--},t.nextPage=function(){t.currentPage++},t.paginationStatusNext=function(){return t.currentPage>Math.ceil(t.posts.container.length/t.pageSize)-2},angular.element(document).ready(function(){componentHandler.upgradeAllRegistered()}),t.submitForm=function(){if(t.userPost.title){var e={title:t.userPost.title,content:t.userPost.content,image:t.userPost.image,rating:0};n.addPost(e)}}}]),app.controller("PostsCtrl",["$scope","posts","post",function(t,n,e){angular.element(document).ready(function(){componentHandler.upgradeAllRegistered()}),t.post=e,t.submitForm=function(){n.addComment(t.post,t.userComment)}}]),app.controller("AuthCtrl",["$scope","$state","auth",function(t,n,e){t.user={},t.register=function(){e.register(t.user).error(function(n){t.error=n}).then(function(){n.go("home")})},t.logIn=function(){e.logIn(t.user).error(function(n){t.error=n}).then(function(){n.go("home")})}}]),app.filter("startFrom",function(){return function(t,n){return t?(n=+n,t.slice(n)):[]}}),app.factory("posts",["imgurLinkGenerator","$http",function(t,n){function e(t,n,e){this.author=t?t:"John Doe",this.body=n?n:"No comment",this.rating=e?e:0}function o(t,n,e,o,r){this.title=t?t:"",this.link=n?n:"",this.content=e?e:"",this.comments=o?o:[],this.rating=r?r:0}var r={container:[]};return r.Post=o,r.Comment=e,r.getAll=function(){return n.get("/posts").success(function(t){angular.copy(t,r.container)})},r.getPostById=function(t){return n.get("/posts/"+t).then(function(t){return t.data})},r.addPost=function(e){(e.image+"").match(/^(http:\/\/){0,1}i.imgur.com\/[A-Za-z0-9]{5,7}\.(jpg|png|jpeg|gif)$/i)?n.post("/posts",e).success(function(t){r.container.push(t)}):t.getImgurLink().then(function(t){e.image=t,n.post("/posts",e).success(function(t){r.container.push(t)})})},r.addComment=function(t,e){return e.author=e.author?e.author:"John Doe",n.post("/posts/"+t._id+"/comments",e).success(function(n){t.comments.push(n)})},r.upvotePost=function(t){return n.put("/posts/"+t._id+"/upvote").success(function(n){t.rating+=1})},r.downvotePost=function(t){return n.put("/posts/"+t._id+"/downvote").success(function(n){t.rating-=1})},r.upvoteComment=function(t,e){return n.put("/posts/"+t._id+"/comments/"+e._id+"/upvote").success(function(t){e.rating+=1})},r.downvoteComment=function(t,e){return n.put("/posts/"+t._id+"/comments/"+e._id+"/downvote").success(function(t){e.rating-=1})},r}]),app.factory("auth",["$http","$window",function(t,n){var e={};return e.saveToken=function(t){n.localStorage["flapper-news-token"]=t},e.getToken=function(){return n.localStorage["flapper-news-token"]},e.isLoggedIn=function(){var t=e.getToken();if(t){var o=JSON.parse(n.atob(t.split(".")[1]));return o.exp>Date.now()/1e3}return!1},e.currentUser=function(){if(e.isLoggedIn()){var t=e.getToken(),o=JSON.parse(n.atob(t.split(".")[1]));return o.username}},e.register=function(n){return t.post("/register",n).success(function(t){e.saveToken(t.token)})},e.logIn=function(n){return t.post("/login",n).success(function(t){e.saveToken(t.token)})},e.logOut=function(){n.localStorage.removeItem("flapper-news-token")},e}]),app.factory("imgurLinkGenerator",["$q",function(t){function n(t,n){return Math.round(Math.random()*(n-t)+t)}function e(t){for(var i,u=n(0,1)?5:7,c="";u--;)i=r[n(0,s)],c+=i;img=new Image,img.addEventListener("load",function(){this.width<=300||this.height<=300?e(t):t.resolve(this.src)},!1),img.addEventListener("error",function(){e(t)},!1),img.src=o+c+".jpg"}var o="http://i.imgur.com/",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=r.length-1,i=function(){var n=t.defer();return e(n),n.promise};return{getImgurLink:i}}]);